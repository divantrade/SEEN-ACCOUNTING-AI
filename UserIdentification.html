<!DOCTYPE html>
<html dir="rtl">

<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
    }

    .container {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .header .icon {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .header h2 {
      margin: 0;
      color: #333;
      font-size: 18px;
    }

    .header p {
      margin: 8px 0 0;
      color: #666;
      font-size: 13px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #444;
      font-size: 14px;
    }

    select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      background: #fafafa;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: left 12px center;
      padding-left: 35px;
    }

    select:focus {
      outline: none;
      border-color: #667eea;
      background-color: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #666;
    }

    .btn-secondary:hover {
      background: #eee;
    }

    .current-user {
      background: #e8f5e9;
      border: 1px solid #a5d6a7;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #2e7d32;
    }

    .current-user strong {
      color: #1b5e20;
    }

    .note {
      background: #fff3e0;
      border: 1px solid #ffcc80;
      border-radius: 8px;
      padding: 10px 12px;
      margin-top: 16px;
      font-size: 12px;
      color: #e65100;
    }

    .loading {
      text-align: center;
      padding: 30px;
      color: #666;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="loadingState" class="loading">
      <div class="spinner"></div>
      <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
    </div>

    <div id="mainContent" style="display: none;">
      <div class="header">
        <div class="icon">ğŸ‘¤</div>
        <h2>ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
        <p>ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù…Ùƒ Ù„ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø·Ùƒ ÙÙŠ Ø§Ù„Ø´ÙŠØª</p>
      </div>

      <div id="currentUserInfo" class="current-user" style="display: none;">
        Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong id="currentUserName"></strong>
      </div>

      <div class="form-group">
        <label>Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:</label>
        <select id="userSelect">
          <option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ --</option>
        </select>
      </div>

      <div class="buttons">
        <button class="btn btn-primary" id="btnConfirm" onclick="confirmUser()" disabled>
          âœ… ØªØ£ÙƒÙŠØ¯
        </button>
        <button class="btn btn-secondary" onclick="google.script.host.close()">
          Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>

      <div class="note">
        ğŸ’¡ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©. Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ ØªØ¬Ø±ÙŠÙ‡ Ø³ÙŠÙØ³Ø¬Ù„ Ø¨Ø§Ø³Ù…Ùƒ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·.
      </div>
    </div>
  </div>

  <script>
    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ…Ø±Ø±Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    const USERS_DATA = <?!= JSON.stringify(usersData) ?>;

    document.addEventListener('DOMContentLoaded', function() {
      try {
        if (USERS_DATA && USERS_DATA.users) {
          populateUsers(USERS_DATA.users, USERS_DATA.currentUser);
        } else {
          throw new Error('Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†');
        }
      } catch (e) {
        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + e.message);
      }
    });

    function populateUsers(users, currentUser) {
      const select = document.getElementById('userSelect');
      const btnConfirm = document.getElementById('btnConfirm');

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
      if (users && users.length > 0) {
        users.forEach(function(user) {
          const option = document.createElement('option');
          option.value = JSON.stringify({ name: user.name, email: user.email || '' });
          option.textContent = user.display || user.name;
          select.appendChild(option);
        });
      } else {
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± ÙŠØ¯ÙˆÙŠ
        const option = document.createElement('option');
        option.value = JSON.stringify({ name: 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„', email: '' });
        option.textContent = 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„';
        select.appendChild(option);
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù† ÙˆØ¬Ø¯
      if (currentUser && currentUser.name) {
        document.getElementById('currentUserInfo').style.display = 'block';
        document.getElementById('currentUserName').textContent = currentUser.name;

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        for (let i = 0; i < select.options.length; i++) {
          try {
            const optValue = JSON.parse(select.options[i].value);
            if (optValue.name === currentUser.name) {
              select.selectedIndex = i;
              btnConfirm.disabled = false;
              break;
            }
          } catch (e) {}
        }
      }

      // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
      select.addEventListener('change', function() {
        btnConfirm.disabled = !this.value;
      });

      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
    }

    function confirmUser() {
      const select = document.getElementById('userSelect');
      if (!select.value) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù…Ùƒ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
        return;
      }

      try {
        const userData = JSON.parse(select.value);

        // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        google.script.run
          .withSuccessHandler(function() {
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
            google.script.host.close();
          })
          .withFailureHandler(function(err) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + err.message);
          })
          .saveCurrentUserIdentity(userData.name, userData.email);
      } catch (e) {
        alert('Ø®Ø·Ø£: ' + e.message);
      }
    }
  </script>
</body>

</html>
